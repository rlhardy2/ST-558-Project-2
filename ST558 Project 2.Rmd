---
title: "ST 558 Project 2"
author: "Matthew Sookoo and Rachel Hardy"
date: "2022-10-10"
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Introduction

Our goal with this project is to create a vignette about contacting an API using functions we’ve created to query, parse, and return well-structured data. We’ll then use our functions to obtain data from the API and do some exploratory data analysis!

# Required packages

To use the functions for interacting with the API, the following packages are used:

* `tidyverse`: Tons of useful features for data manipulation and visualization!
* `jsonlite`: Used for API interaction.
* `httr`: Used to make http requests in R language as it provides a wrapper for the curl package.
* `knitr`: Used for displaying tables in a markdown-friendly way.

```{r libraries, include = FALSE}
library(tidyverse)
library(jsonlite)
library(httr)
library(knitr)
```

# Writing the Functions

In this section we will write the functions for data retrieval. These functions will allow the user to customize their query to return specific data. We will be using an API that is focused on breweries. Each function will return a data frame with variables such as brewery ID, name, type, address (street, city, and state variables), postal code, country, longitude, latitude, phone number, and website URL to name a few. Each function will have a brief description.

## Function Number One: listBreweries()

The first function is a function that will return a list of breweries of user-specified length. Default length is 20 and maximum length is 50.

```{r}
listBreweries <- function(length = 20) {
  
  #Create the full URL that will be used to retrieve the data.
  baseURL <- "https://api.openbrewerydb.org/"
  endpoint <- "breweries?per_page="
  fullURL = paste0(baseURL, endpoint, length)
  
  #Get the API output.
  outputAPI <- GET(fullURL)
  
  #Parse the API output to get a data frame.
  finalAPI <- fromJSON(rawToChar(outputAPI$content))
  
  #Make sure latitude and longitude are numeric.
  finalAPI$longitude <- as.numeric(finalAPI$longitude)
  finalAPI$latitude <- as.numeric(finalAPI$latitude)
  
  #Return the final data frame.
  return(as_tibble(finalAPI))
}
```

## Function Number Two: listByState()

The second function is a function that will return a list of breweries of user-specified length and state. Default length is 20 and default state is North Carolina.

```{r}
listByState <- function(state = "North Carolina", length = 20) {
  
  #Make sure state is all lowercase with underscores instead of spaces.
  state <- tolower(state)
  state <- sub(" ", "_", state)
  
  #Create the full URL that will be used to retrieve the data.
  baseURL <- "https://api.openbrewerydb.org/"
  endpoint1 <- "breweries?by_state="
  endpoint2 <- "&per_page="
  fullURL = paste0(baseURL, endpoint1, state, endpoint2, length)
  
  #Get the API output.
  outputAPI <- GET(fullURL)
  
  #Parse the API output to get a data frame.
  finalAPI <- fromJSON(rawToChar(outputAPI$content))
  
  #Make sure latitude and longitude are numeric.
  finalAPI$longitude <- as.numeric(finalAPI$longitude)
  finalAPI$latitude <- as.numeric(finalAPI$latitude)
  
  #Return the final data frame.
  return(as_tibble(finalAPI))
}
```

## Function Number Three: listByCity()

The third function is a function that will return a list of breweries of user-specified length and city. Default length is 20 and default city is San Diego, California.

```{r}
listByCity <- function(city = "San Diego", length = 20) {
  
  #Make sure city is all lowercase with underscores instead of spaces.
  city <- tolower(city)
  city <- sub(" ", "_", city)
  
  #Create the full URL that will be used to retrieve the data.
  baseURL <- "https://api.openbrewerydb.org/"
  endpoint1 <- "breweries?by_city="
  endpoint2 <- "&per_page="
  fullURL = paste0(baseURL, endpoint1, city, endpoint2, length)
  
  #Get the API output.
  outputAPI <- GET(fullURL)
  
  #Parse the API output to get a data frame.
  finalAPI <- fromJSON(rawToChar(outputAPI$content))
  
  #Make sure latitude and longitude are numeric.
  finalAPI$longitude <- as.numeric(finalAPI$longitude)
  finalAPI$latitude <- as.numeric(finalAPI$latitude)
  
  #Return the final data frame.
  return(as_tibble(finalAPI))
}
```

## Function Number Four: listByDistance()

The fourth function is a function that will return a list of breweries of user-specified length and sort the results by distance from a user-specified origin point (latitude, longitude). Default length is 20 and default origin point is Raleigh, North Carolina (35.7796, -78.6382).

```{r}
listByDistance <- function(lat = 35.7796, long = -78.6382, length = 20) {
  
  #Create the full URL that will be used to retrieve the data.
  baseURL <- "https://api.openbrewerydb.org/"
  endpoint1 <- "breweries?by_dist="
  endpoint2 <- "&per_page="
  fullURL = paste0(baseURL, endpoint1, lat, ",", long, endpoint2, length)
  
  #Get the API output.
  outputAPI <- GET(fullURL)
  
  #Parse the API output to get a data frame.
  finalAPI <- fromJSON(rawToChar(outputAPI$content))
  
  #Make sure latitude and longitude are numeric.
  finalAPI$longitude <- as.numeric(finalAPI$longitude)
  finalAPI$latitude <- as.numeric(finalAPI$latitude)
  
  #Return the final data frame.
  return(as_tibble(finalAPI))
}
```

## Function Number Five: listByType()

The fifth function is a function that will return a list of breweries of user-specified length and type. Default length is 20 and default type is micro.

The different types of breweries are listed below:

* `micro`: Most craft breweries. For example, Samuel Adams is still considered a micro brewery.
* `nano`: An extremely small brewery which typically only distributes locally.
* `regional`: A regional location of an expanded brewery. Ex. Sierra Nevada’s Asheville, NC location.
* `brewpub`: A beer-focused restaurant or restaurant/bar with a brewery on-premise.
* `large`: A very large brewery. Likely not for visitors. Ex. Miller-Coors. (deprecated)
* `planning`: A brewery in planning or not yet opened to the public.
* `bar`: A bar. No brewery equipment on premise. (deprecated)
* `contract`: A brewery that uses another brewery’s equipment.
* `proprietor`: Similar to contract brewing but refers more to a brewery incubator.
* `closed`: A location which has been closed.

```{r}
listByType <- function(type = "micro", length = 20) {
  
  #Make sure type is all lowercase.
  type <- tolower(type)
  
  #Create the full URL that will be used to retrieve the data.
  baseURL <- "https://api.openbrewerydb.org/"
  endpoint1 <- "breweries?by_type="
  endpoint2 <- "&per_page="
  fullURL = paste0(baseURL, endpoint1, type, endpoint2, length)
  
  #Get the API output.
  outputAPI <- GET(fullURL)
  
  #Parse the API output to get a data frame.
  finalAPI <- fromJSON(rawToChar(outputAPI$content))
  
  #Make sure latitude and longitude are numeric.
  finalAPI$longitude <- as.numeric(finalAPI$longitude)
  finalAPI$latitude <- as.numeric(finalAPI$latitude)
  
  #Return the final data frame.
  return(as_tibble(finalAPI))
}
```

## Function Number Six: listBySearch()

The sixth function is a function that will return a list of breweries of user-specified length based on a search term. Default length is 20 and the user *must* specify a search term.

```{r}
listBySearch <- function(search, length = 20) {
  
  #Make sure the search term is all lowercase with underscores instead of spaces.
  search <- tolower(search)
  search <- sub(" ", "_", search)
  
  #Create the full URL that will be used to retrieve the data.
  baseURL <- "https://api.openbrewerydb.org/"
  endpoint1 <- "breweries/search?query="
  endpoint2 <- "&per_page="
  fullURL = paste0(baseURL, endpoint1, search, endpoint2, length)
  
  #Get the API output.
  outputAPI <- GET(fullURL)
  
  #Parse the API output to get a data frame.
  finalAPI <- fromJSON(rawToChar(outputAPI$content))
  
  #Make sure latitude and longitude are numeric.
  finalAPI$longitude <- as.numeric(finalAPI$longitude)
  finalAPI$latitude <- as.numeric(finalAPI$latitude)
  
  #Return the final data frame.
  return(as_tibble(finalAPI))
}
```

# Data Retreival and Exploratory Analysis

In this section we will use the functions from the previous section to extract our data and then we will analyze it using the `tidyverse` package!

## Data Retreival Examples

### Brewpubs and Bars: Wisconsin vs North Dakota

We maybe interested in the percentage of brewpubs (a beer-focused restaurant or restaurant/bar with a brewery on-premise) or bars (no brewery equipment on premise) in Wisconsin and North Dakota as these two states were found to be the two states that consumed the most alcohol. click [here](https://www.thecentersquare.com/wisconsin/this-is-where-wisconsin-ranks-among-the-drunkest-states-in-america/article_3ccd11a4-c261-563b-919a-e02a0254b6dd.html) for more information.

Below, we create a new helper variable "brewpub_or_bar_1_0" to display 1 if brewery type is either "brewpub or "bar" and 0 otherwise. We then group the observations by state to find the percent of breweries in each state that are either a brewpub or a bar. 

As seen in the tibble below, 38.0% of Wisconsin breweries are either a brewpub or a bar, while only 34.6% of North Dakota breweries are either a brewpub or a bar. 

Note that this does not include all possible breweries, as our API only allows us to access 50 observations for each function called.

```{r}
wisconsin <- listByState("Wisconsin", 50)
ndakota <- listByState("North Dakota", 50)

#Create the combined tibble.
combined_tibble <- rbind(wisconsin, ndakota)%>%
  
  mutate(brewpub_or_bar_1_0 = if_else((brewery_type == "brewpub" | brewery_type == "bar"), 1, 0)) %>%
  
  group_by(state) %>%
  
  mutate(percent_brewpub_bar = mean(brewpub_or_bar_1_0)*100) %>% 
  
  select(brewpub_or_bar_1_0, percent_brewpub_bar, everything())

#Print the combined tibble.
combined_tibble
```

### Exploring Distance: Madison, Wisconsin

Since Wisconsin beat North Dakota in the comparison above, let's see how many breweries are close to the capital of the state: Madison, Wisconsin. The latitude and longitude of Madison, Wisconsin is 43.0722 and -89.4008, respectively. The 50 breweries closest to Madison, Wisconsin can be seen in the tibble below.

```{r}
madison <- listByDistance(lat = 43.0722, long = -89.4008, length = 50)

#Print the tibble.
madison
```

From the tibble above, we can create a modified tibble showing us which breweries have a distance away from the origin point of both 0.05 longitude *AND* 0.05 latitude. If the "lat_and_long" variable equals 1, this is true, and if it equals 0, this is false.

As seen in the modified tibble below, of the 50 breweries closest to Madison, Wisconsin, only 6 are both more than 0.05 longitude and 0.05 latitude away from the origin point.

```{r}
#Create the modified tibble.
madison_modified <- madison %>% 
  
  mutate(lat_and_long = if_else((longitude > -89.4508 & latitude > 43.1222), 1, 0)) %>%
  
  select(lat_and_long, everything()) %>%
  
  filter(lat_and_long == 1)

#Print the modified tibble.
madison_modified
```

### Summary of Latitude and Longitude: San Diego, California

The latitude and longitude of San Diego, California is 32.7157 and -117.1611, respectively. We can create a tibble of breweries in San Diego and find some summary statistics for the latitude and longitude variables. Mathematically speaking, these numbers may not make a lot of sense, this is just for the sake of showing the process!

```{r}
san_diego <- listByCity(city = "San Diego", length = 50)

#Print the tibble.
san_diego
```

Now, we will use the summarize() function to find some summary statistics.

```{r}
#Creating the summary for longitude.
long_summary <- san_diego %>% summarize(mean = mean(longitude), min = min(longitude), max = max(longitude))

#Print the summary.
long_summary

#Creating the summary for latitude.
lat_summary <- san_diego %>% summarize(mean = mean(latitude), min = min(latitude), max = max(latitude))

#Print the summary.
lat_summary
```

As seen above in our list of 50 breweries in San Diego, the average longitude is -117.1546 and the average latitude is 32.8133. The respective minimum values are -117.2511 and 32.69822. The respective maximum values are -117.0858 and 32.02391. As expected, latitude and longitude do not vary much within a single city.

## Contingency Tables
 
We are interested in the two states with the highest consumption of alcohol, namely Wisconsin and North Dakota. We show a contingency table for brewery type in Wisconsin, another contingency table for brewery type in North Dakota and finally a two-way contingency table for brewery_type for both states.
 
```{r}
wisconsin_only<-combined_tibble %>% filter(state == "Wisconsin")
table(wisconsin_only$brewery_type)

n_dakota_only<-combined_tibble %>% filter(state == "North Dakota")
table(n_dakota_only$brewery_type)
  
table(combined_tibble$brewery_type, combined_tibble$state)
```
 
Next we create some numerical summaries for the mean and standard deviations of the longitude and latitude values across our two states of interest Wisconsin and North Dakota. It should be noted that the combine_tibble object is already group_by(state) and we remove the Na values.

```{r}
combined_tibble%>%filter(longitude != "Na", latitude != "Na")%>%
  mutate(longitude = as.numeric(longitude))%>% 
  mutate(latitude = as.numeric(latitude))%>%
summarize(mean(longitude), mean(latitude), sd(longitude), sd(latitude))
  
```

## Plots

### Histogram
We can use a continuous valued variable such as latitude or longitude.
```{r}
combined_tibble2 <- combined_tibble%>%filter(longitude != "Na", latitude != "Na")%>%
  mutate(longitude = as.numeric(longitude))%>% 
  mutate(latitude = as.numeric(latitude))

ggplot(combined_tibble2, aes(x=latitude)) + geom_histogram(fill="green", col="orange")
```

### Bar Plot
We use a categorical variable we use fill as an aesthetic rather than an attribute
```{r}
ggplot(combined_tibble2, aes(x=brewery_type, fill=brewery_type)) + geom_bar()
```

### Scatter Plot
We use the scatter plot to understand the distribution between two numeric columns which we is our longitude and latitude columns. We investigate how do the longitude vary with latitude.

```{r}
ggplot(combined_tibble2, aes(y=longitude, x= latitude, col=brewery_type)) + geom_point()
```

### Box Plot
In a box plot we try to investigate how a numerical value change with a categorical value. We choose latitude for the numerical value and brewery type for the categorical variable.
```{r}
ggplot(combined_tibble2, aes(x = brewery_type, y = latitude, fill=brewery_type )) + geom_boxplot()

ggplot(combined_tibble2, aes(x = brewery_type, y = latitude, fill=state )) + geom_boxplot()

ggplot(combined_tibble2, aes(x = brewery_type, y = latitude, fill=state )) + geom_boxplot() + facet_grid(~state)
```


